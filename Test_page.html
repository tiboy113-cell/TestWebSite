<!DOCTYPE html>
<html lang="en">
<head>
  <title>Local Grey Kiosk - Full Demo</title>
  <meta name="viewport" content="width=460,initial-scale=1">
  <meta charset="utf-8">
  <!-- Camera QR/CC scan libs: -->
  <script src="https://unpkg.com/html5-qrcode@2.4.3/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/@microblink/cardscan@2.3.0/dist/cardscan.umd.min.js"></script>
  <style>
    body { background: #f4f6f9; font-family: 'SF Pro Display', Arial, sans-serif; margin:0; color: #222a32;}
    .app-container { max-width: 458px; margin: 30px auto; background: #fff; border-radius: 22px; overflow: hidden; box-shadow: 0 6px 32px #0054a642;}
    .app-header { background: #555A62; color: #fff; font-size: 2rem; font-weight: bold; letter-spacing:.02em; text-align:center; border-radius: 22px 22px 0 0; padding: 22px 0 19px 0; }
    .screen { padding: 28px 16px 14px 16px; min-height: 430px;}
    h2 { font-size: 1.18rem; color: #0054A6; margin-top:2px; margin-bottom:16px;}
    .card { background: #e6f0fa; border-radius: 18px; padding: 18px 18px; margin: 24px 0 15px 0;}
    ul { padding-left: 22px; margin: 0 0 12px 0;}
    .elig, .card strong {font-weight: bold;}
    label { font-weight: 600; color: #144169; margin-top:.7em; display: block;}
    input, select, textarea, .picker-input, .btn-primary, .btn-secondary, video { width: 100%; box-sizing: border-box;}
    input, select, textarea { font-size: 1rem; padding: 15px; border-radius: 14px; border: 1.5px solid #b0c6e8; background: #fff; margin-bottom: 13px;}
    input:focus, select:focus, textarea:focus { border-color: #0054A6; background: #e6f0fa; outline: none;}
    textarea { min-height: 60px;}
    .btn-primary { background: #0054A6; color: white; padding: 15px 0; border: none; border-radius: 18px; font-size: 1.15rem; font-weight: 700; margin-top: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px #0054a622; cursor: pointer;}
    .btn-primary:active { background: #003366;}
    .btn-secondary { background: #f4f6f9; color: #0054A6; border: 1.5px solid #b0c6e8; font-weight: 600; padding: 14px 0; border-radius: 18px; margin-bottom: 10px; cursor: pointer;}
    .receipt-list { background: #f4f6f9; margin-bottom: 7px; border-radius: 18px; padding: 10px 7px;}
    .receipt { background: #fff; border-radius: 14px; box-shadow: 0 1px 6px #0054A622; padding: 10px 13px; margin-bottom: 7px; display: flex; align-items: center; justify-content: space-between;}
    .popup, .modal, .qr-modal, .cardscan-modal { position: fixed; top: 50%; left: 50%; width: 350px; max-width: 96vw; background: #fff; border-radius: 18px; box-shadow: 0 6px 32px #0054A644; padding: 22px 17px 22px 17px; transform: translate(-50%, -50%); z-index: 104;}
    .overlay, .modal-bg { background: #0054A622; position: fixed; inset: 0; z-index: 99;}
    .checkbox-label {display:flex;align-items:center;gap:8px;font-size:1.04rem;}
    input[type="checkbox"]{width:22px;height:22px;accent-color:#0054A6;}
    video {border-radius:18px;background:#f4f6f9;margin-bottom:13px;display:block;}
    .picker-label {font-weight:600;color:#0054A6;margin-bottom:7px;margin-top:10px;display:block;}
    .picker-input {font-size:1.08rem;border-radius:15px;padding:14px;border:1.5px solid #B0C6E8;background:#f4f6f9;cursor:pointer;text-align:left;color:#222;margin-bottom:13px;margin-top:5px;transition:border .15s;user-select:none;}
    .picker-input:active,.picker-input:focus{border-color:#0054A6;}
    .picker-modal{position:fixed;top:50%;left:50%;width:350px;max-width:96vw;padding:0 0 10px 0;background:#fff;border-radius:18px;box-shadow:0 6px 32px #0054A684;transform:translate(-50%,-50%);z-index:100;display:flex;flex-direction:column;align-items:stretch;}
    .picker-wheel-wrap{flex:1 1 auto;height:196px;overflow:hidden;position:relative;}
    .picker-wheel{height:100%;overflow-y:scroll;overscroll-behavior:contain;scroll-behavior:smooth;}
    .picker-list{margin:0;padding:0;list-style:none;min-height:100%;}
    .picker-item{height:38px;line-height:38px;font-size:1.02rem;text-align:center;cursor:pointer;color:#174699;border-radius:9px;user-select:none;transition:background .14s,color .14s;margin:0 10px;}
    .picker-item.selected{background:#0054A6;color:#fff;font-weight:700;}
    .picker-highlight{position:absolute;left:0;right:0;top:69px;height:38px;border-radius:10px;pointer-events:none;border:2px solid #0054A6;box-sizing:border-box;background:rgba(0,84,166,.05);z-index:9;}
    .picker-actions{padding:12px 28px 0 24px;display:flex;justify-content:flex-end;}
    .picker-close{font-size:1.02rem;background:#555a62;color:#fff;border:none;border-radius:10px;padding:7px 23px;cursor:pointer;font-weight:600;margin-left:4px;}
    .picker-close:hover{background:#0054a6;}
    .qr-modal camera, .qr-modal #reader, .qr-video, .qr-preview { width: 100% !important; max-width: 320px;}
    .qr-modal {background:#fff;border-radius:14px;box-shadow:0 5px 32px #0054a666;width:340px;max-width:98vw;padding:10px 4px 18px 4px;}
    .qr-close,.cardscan-close{background:#555a62;color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:700;padding:8px 28px;margin-top:16px;cursor:pointer;}
    .qr-close:hover,.cardscan-close:hover{background:#0054A6;}
    #reader>video{border-radius:10px;}
    .cardscan-modal{background:#fff;border-radius:16px;box-shadow:0 5px 32px #0054a666;width:320px;max-width:96vw;padding:12px 0 18px 0;display:flex;flex-direction:column;align-items:center;}
    .ccfield input[readonly]{background:#e6f0fa;color:#0054A6;}
  </style>
</head>
<body>
<div class="app-container"><div class="app-header">Local Grey</div><div id="flow"></div></div>
<div id="modalBg" class="modal-bg" style="display:none"></div>
<script>
const state = {
  step: 0,
  language: "English",
  passport: "",
  qrData: "",
  traveler: { name: "", address: "", email: "", passport: "" },
  residence: { country: "", departure: "" },
  memberEmail: "",
  receipts: [
    {number: '12345', amount: 150, store: 'PRINTEMPS'},
    {number: '23456', amount: 87, store: 'Lafayette'},
    {number: '42407', amount: 224, store: 'ZARA'},
    {number: '59234', amount: 54, store: 'Carrefour'},
    {number: '13090', amount: 68, store: 'Starbucks'},
    {number: '99123', amount: 300, store: 'Galeries'},
    {number: '77222', amount: 25, store: 'Uniqlo'},
    {number: '81654', amount: 178, store: 'Apple Store'}
  ],
  refund: "",
  agreed: false,
  needAssistant: false,
  assistantApproved: false,
  card: { pan: "", expiry: "", name: "", ccv: "" }
};
const languages = ["English","Mandarin","Hindi","Spanish","French","Arabic","Bengali","Russian","Portuguese","Urdu","Indonesian","German","Japanese","Swahili","Marathi","Telugu","Turkish","Korean","Vietnamese","Italian"];
function showPickerWheel(current, callback) {
  const modalBg = document.getElementById("modalBg");modalBg.style.display = "block";
  let idx = languages.indexOf(current); if(idx<0)idx=0;
  const modal = document.createElement('div');
  modal.className = "picker-modal";
  modal.innerHTML = `
    <div class="picker-wheel-wrap"><div class="picker-highlight"></div>
    <div class="picker-wheel"><ul class="picker-list">
    ${languages.map((lang, i) => `<li class="picker-item${i==idx?' selected':''}" data-idx="${i}">${lang}</li>`).join('')}
    </ul></div></div>
    <div class="picker-actions"><button class="picker-close">Close</button></div>`;
  document.body.appendChild(modal);
  const items = modal.querySelectorAll('.picker-item'); const wheel = modal.querySelector('.picker-wheel'); const h=38;
  setTimeout(()=>{wheel.scrollTop=idx*h;hl();},30);
  function hl(f,x){let idx=Math.round(wheel.scrollTop/h);if(idx<0)idx=0; if(idx>languages.length-1)idx=languages.length-1;
  items.forEach((it,i)=>it.classList.toggle('selected',i==idx));if(!x)wheel.scrollTo({top:idx*h,behavior:'smooth'});if(f)items[idx].focus();}
  wheel.addEventListener('scroll',()=>{hl();});modal.querySelector('.picker-list').onclick=e=>{
    if(e.target.classList.contains('picker-item')) callback(languages[Number(e.target.dataset.idx)]),cls()};
  modal.querySelector('.picker-close').onclick=cls;modalBg.onclick=cls;
  function cls(){document.body.removeChild(modal);modalBg.style.display="none";document.getElementById('langPickerField')?.focus();}
}
function showDatePicker(current, callback) {
  const modalBg=document.getElementById("modalBg");
  modalBg.style.display="block";
  let y,m,d,now=new Date(),v=(current||'').split('-');y=+v[0]||now.getFullYear();m=+v[1]||now.getMonth()+1;d=+v[2]||now.getDate();
  let years=[],months=[],days=[];
  for(let i=now.getFullYear()-1;i<=now.getFullYear()+3;i++) years.push(i);
  for(let i=1;i<=12;i++) months.push(i);
  function updateDays(yy,mm){days=[];for(let i=1;i<=new Date(yy,mm,0).getDate();i++)days.push(i);}
  updateDays(y,m);
  const modal=document.createElement('div');
  modal.className="date-modal";
  modal.innerHTML=`<div class="date-wheel-row">
    <div class="date-wheel-col"><div class="date-wheel-wrap"><div class="date-highlight"></div>
    <div class="date-wheel"><ul class="date-years">${years.map(yy=>`<li class="date-item${yy===y?' selected':''}" data-val="${yy}">${yy}</li>`).join('')}</ul></div></div></div>
    <div class="date-wheel-col"><div class="date-wheel-wrap"><div class="date-highlight"></div>
    <div class="date-wheel"><ul class="date-months">${months.map(mm=>`<li class="date-item${mm===m?' selected':''}" data-val="${mm}">${String(mm).padStart(2,'0')}</li>`).join('')}</ul></div></div></div>
    <div class="date-wheel-col"><div class="date-wheel-wrap"><div class="date-highlight"></div>
    <div class="date-wheel"><ul class="date-days">${days.map(dd=>`<li class="date-item${dd===d?' selected':''}" data-val="${dd}">${String(dd).padStart(2,'0')}</li>`).join('')}</ul></div></div></div>
    </div>
    <div class="date-actions"><button class="date-close">Close</button>
    <button class="btn-primary" id="dateSelectBtn">Select</button></div>`;
  document.body.appendChild(modal);
  function snap(list,arr,v){let idx=arr.indexOf(v);if(idx<0)idx=0;list.parentElement.parentElement.querySelector('.date-wheel').scrollTop=idx*40;hl(list,arr);}
  function hl(list,arr){let idx=Math.round((list.parentElement.parentElement.querySelector('.date-wheel').scrollTop)/40);if(idx<0)idx=0;if(idx>arr.length-1)idx=arr.length-1;Array.from(list.children).forEach((li,i)=>li.classList.toggle('selected',i===idx));}
  setTimeout(()=>{snap(modal.querySelector('.date-years'),years,y);snap(modal.querySelector('.date-months'),months,m);snap(modal.querySelector('.date-days'),days,d);},20);
  modal.querySelectorAll('.date-years,.date-months,.date-days').forEach(ul=>{
    ul.addEventListener('click',e=>{
      if(e.target.classList.contains('date-item')){
        let idx=Array.from(ul.children).indexOf(e.target);ul.parentElement.parentElement.querySelector('.date-wheel').scrollTo({top:idx*40,behavior:'smooth'});hl(ul,Array.from(ul.children).map(li=>+li.dataset.val||+li.textContent));
        if(ul.classList.contains('date-years')||ul.classList.contains('date-months')){
          let idxY=Array.from(modal.querySelector('.date-years').children).findIndex(li=>li.classList.contains('selected'));
          let idxM=Array.from(modal.querySelector('.date-months').children).findIndex(li=>li.classList.contains('selected'));
          let yy=years[idxY],mm=months[idxM];updateDays(yy,mm);
          let daysList=modal.querySelector('.date-days');daysList.innerHTML=days.map(dd=>`<li class="date-item${dd===d?' selected':''}" data-val="${dd}">${String(dd).padStart(2,'0')}</li>`).join('');
          snap(daysList,days,days[0]);
        }
      }
    });
  });
  modal.querySelector('#dateSelectBtn').onclick=()=>{let idxY=Array.from(modal.querySelector('.date-years').children).findIndex(li=>li.classList.contains('selected'));let idxM=Array.from(modal.querySelector('.date-months').children).findIndex(li=>li.classList.contains('selected'));let idxD=Array.from(modal.querySelector('.date-days').children).findIndex(li=>li.classList.contains('selected'));let yy=years[idxY],mm=months[idxM],dd=days[idxD];callback(`${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`);cls();};
  function cls(){document.body.removeChild(modal);modalBg.style.display="none";}
  modal.querySelector('.date-close').onclick=cls;modalBg.onclick=cls;
}
function showPopup(title, html) {
  const modalBg = document.getElementById("modalBg"); modalBg.style.display = "block";
  const popup = document.createElement("div");
  popup.className = "popup";
  popup.innerHTML = `<h3 style="margin-top:0">${title}</h3><div style="margin-bottom:24px">${html}</div><button class="btn-primary" id="closePopupBtn" style="margin-top:10px">Close</button>`;
  document.body.appendChild(popup);
  document.getElementById("closePopupBtn").onclick = close; modalBg.onclick = close;
  function close() { document.body.removeChild(popup); modalBg.style.display="none";}
}
function showQrModal(onScan) {
  if(window.qrScannerActive)return;window.qrScannerActive=true;
  const modalBg=document.getElementById("modalBg");modalBg.style.display="block";
  let qrdiv = document.createElement("div");
  qrdiv.className = "qr-modal";
  qrdiv.innerHTML = `<div id="reader" style="width:100%; max-width:320px; margin:auto;"></div>
    <button class="qr-close" id="qrCloseBtn">Close</button>
    <div id="qrMsg" style="text-align:center;font-size:1.08em;margin:8px 0 0 0;color:#0054A6;"></div>`;
  document.body.appendChild(qrdiv);
  let scanner = new Html5Qrcode("reader");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:220},code=>{onScan(code);document.getElementById('qrMsg').textContent="✅ QR recognized!";close();},() =>{}).catch(()=>{document.getElementById('qrMsg').textContent="Camera not available.";});
  document.getElementById('qrCloseBtn').onclick = close;modalBg.onclick=close;
  function close(){window.qrScannerActive=false;scanner.stop().then(()=>scanner.clear());document.body.removeChild(qrdiv);modalBg.style.display="none";}
}
function showCardModal(onScan) {
  if(window.cardscanActive)return;window.cardscanActive=true;
  const modalBg=document.getElementById("modalBg");modalBg.style.display="block";
  let cdiv=document.createElement("div");
  cdiv.className="cardscan-modal";
  cdiv.innerHTML=`<div id="cardscan-frame" style="width:260px;height:180px;margin:0 0 12px 0;"></div>
     <button class="cardscan-close" id="closeCardBtn">Cancel</button>
     <div id="cardscanMsg" style="text-align:center;font-size:1em;margin:7px 0 0 0;color:#0054A6;"></div>`;
  document.body.appendChild(cdiv);
  CardScan.showCardScanner({
    onScan:(res)=>{if(res&&res.cardNumber){onScan(res);document.getElementById("cardscanMsg").textContent="✅ Card recognized!";close();}},
    onError:(msg)=>{document.getElementById("cardscanMsg").textContent=msg||"Failed to start camera!";}
  });
  document.getElementById('closeCardBtn').onclick=close;modalBg.onclick=close;
  function close(){window.cardscanActive=false;CardScan.hideCardScanner&&CardScan.hideCardScanner();document.body.removeChild(cdiv);modalBg.style.display="none";}
}
function render() {
  const $flow = document.getElementById("flow");
  let html='';
  if(state.step===0){html=`
    <div>
      <label class="picker-label">Select your language</label>
      <div id="langPickerField" class="picker-input" tabindex="1">${state.language}</div>
      <button class="btn-primary" id="langNextBtn">Next</button>
    </div>`;
  } else if(state.step===1){ html=`
    <div>
      <h2>Have your documents ready</h2>
      <div class="card">
        <ul>
          <li>Passport or ID</li>
          <li>Sales Receipts</li>
          <li>Credit Card or eWallet</li>
        </ul>
        <span class="elig">Eligibility:</span>
        <ul>
          <li>16 years old or older</li>
          <li>Not a European Union resident</li>
          <li>Get Customs validation within 3 months of issuance</li>
        </ul>
      </div>
      <button class="btn-primary" id="docNextBtn">Next</button>
    </div>`;
  } else if(state.step===2){ html=`
    <div>
      <h2>Passport/ID Scanning</h2>
      <video controls poster="https://assets-global.blue.com/videos/passport-scan.jpg">
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4"/>
      </video>
      <label>Type your Passport or ID number</label>
      <input type="text" id="passportInput" value="${state.passport}" placeholder="Passport or ID Number"/>
      <button type="button" class="btn-secondary" id="qrbtn">Scan QR code</button>
      ${state.qrData?`<div style="margin:10px 0 0 0;">
        <label>Scanned QR Value</label>
        <input type="text" value="${state.qrData}" readonly style="font-family:monospace;">
      </div>`:""}
      <button class="btn-primary" id="passportNextBtn">Continue</button>
    </div>`;
  } else if(state.step===3){ html=`
    <div>
      <h2>Traveler Information</h2>
      <input id="travelerName" type="text" placeholder="Full Name" value="${state.traveler.name||''}"/>
      <input id="travelerAddress" type="text" placeholder="Address" value="${state.traveler.address||''}"/>
      <input id="travelerEmail" type="email" placeholder="Email" value="${state.traveler.email||''}"/>
      <input id="travelerPassport" type="text" placeholder="Passport/ID Number" value="${state.traveler.passport||state.passport||''}"/>
      <button class="btn-primary" id="travelerNextBtn">Next</button>
    </div>`;
  } else if(state.step===4){ html=`
    <div>
      <h2>Residence & Departure</h2>
      <label>Country of Residence <input id="residenceCountry" type="text" value="${state.residence.country||''}"/></label>
      <label>Departure Date
      <div id="iosDateField" class="picker-input" tabindex="0">${state.residence.departure||'Select date...'}</div></label>
      <button class="btn-primary" id="residenceNextBtn">Next</button>
    </div>`;
  } else if(state.step===5){ html=`
    <div>
      <h2>Become a Member (optional)</h2>
      <input id="memberEmail" type="email" placeholder="Email" value="${state.memberEmail||''}" />
      <button class="btn-primary" id="membershipJoinBtn">Join</button>
      <button class="btn-secondary" id="membershipSkipBtn">Skip</button>
    </div>`;
  } else if(state.step===6){ html=`
    <div>
      <h2>Your Receipts</h2>
      <div class="receipt-list" id="receiptsList">${
        state.receipts.map((r,i)=>`
         <div class="receipt">
            <span>Receipt #${r.number}, €${r.amount}, Store: ${r.store}</span>
            <button class="btn-secondary" style="width:auto;padding:4px 12px" onclick="window.showReceipt(${i})">View</button>
         </div>`
        ).join('')}
      </div>
      <button class="btn-secondary" id="scanReceiptBtn">Scan New Receipt</button>
      <button class="btn-primary" id="receiptsNextBtn">Next</button>
    </div>`;
  } else if(state.step===7){ html=`
    <div>
      <h2>Choose Refund Method</h2>
      <button class="btn-primary" id="refundCCBtn">Credit Card</button>
      <button class="btn-primary" id="refundWalletBtn">Digital Wallet</button>
      <button class="btn-primary" id="refundCashBtn">Cash</button>
    </div>`;
  } else if(state.step===8){ html=`
    <div>
      <h2>Refund Instructions</h2>
      <video controls poster="https://assets-global.blue.com/videos/payment.jpg">
        <source src="https://www.w3schools.com/html/movie.mp4" type="video/mp4"/>
      </video>
      <p>Refund by: <b>${state.refund}</b>. Please follow on-screen instructions to register your ${state.refund.toLowerCase()} for refund.</p>
      ${
        state.refund === "Credit Card" ?
        `<button class="btn-secondary" type="button" id="scanCardBtn">Scan Card</button>
        <div class="ccfield" style="margin-top:14px;">
          <label>Credit Card Number</label>
          <input id="ccnum" type="text" maxlength="24" value="${state.card.pan||""}" readonly>
          <label>Expiry Date</label>
          <input id="ccexp" type="text" maxlength="7" value="${state.card.expiry||""}" readonly>
          <label>Name on Card</label>
          <input id="ccname" type="text" maxlength="48" value="${state.card.name||""}" readonly>
          <label>Security Code (CVV)</label>
          <input id="cccvv" type="text" maxlength="4" placeholder="Fill yourself" value="${state.card.ccv||""}">
        </div>`
        : ``
      }
      <button class="btn-primary" id="refundNextBtn">Continue</button>
    </div>`;
  } else if(state.step===9){ html=`
    <div>
      <h2>Summary & Traveler Declaration</h2>
      <textarea readonly>${getSummaryText()}</textarea>
      <label class="checkbox-label">
        <input id="agreeCheck" type="checkbox" ${state.agreed?"checked":""}/>
        I accept <button class="linkbtn" id="showTermsLink">Terms & Conditions</button> and <button class="linkbtn" id="showDeclarationLink">Traveler Declaration</button>
      </label>
      <button class="btn-primary" id="submitBtn">Submit</button>
    </div>`;
  } else if(state.step===10){ html=`
    <div>
      <h2>Assistance Required</h2>
      <p>A shop assistant will help you soon.</p>
      <input id="assistantInput" type="text" placeholder="Scan assistant QR code"/>
      <div style="display:flex;gap:12px;margin-top:22px;">
        <button class="btn-primary" id="approveBtn" style="flex:1">Approve</button>
        <button class="btn-secondary" id="rejectBtn" style="flex:1">Reject</button>
      </div>
    </div>`;
  } else if(state.step===11){ html=`
    <div>
      <h2>Collect your Tax Free Form</h2>
      <video controls poster="https://assets-global.blue.com/videos/taxfree_form.jpg">
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4"/>
      </video>
      <div class="card">
        Remember to complete Customs validation at departure!
      </div>
      <button class="btn-primary" id="finishBtn">Finish</button>
    </div>`;
  } else if(state.step===12){ html=`
    <div style="text-align:center;margin-top:77px;">
      <h2>Enjoy your journey!</h2>
      <div style="font-size:20px;color:#0054A699;margin:22px;">Thank you!</div>
    </div>`;
  }
  $flow.innerHTML=html;

  // Event handlers for each step
  switch(state.step){
    case 0:
      document.getElementById('langPickerField').onclick=function(){
        showPickerWheel(state.language,lang=>{state.language=lang;render();});
      };
      document.getElementById('langNextBtn').onclick=()=>{state.step++;render();}; break;
    case 1: document.getElementById('docNextBtn').onclick=()=>{state.step++;render();};break;
    case 2:
      document.getElementById('passportNextBtn').onclick=()=>{state.passport=document.getElementById('passportInput').value;state.traveler.passport=state.passport;state.step++;render();};
      if(document.getElementById('qrbtn')){document.getElementById('qrbtn').onclick=()=>{showQrModal(qr=>{state.qrData=qr;render();});}} break;
    case 3: document.getElementById('travelerNextBtn').onclick=()=>{
        state.traveler.name=document.getElementById('travelerName').value;
        state.traveler.address=document.getElementById('travelerAddress').value;
        state.traveler.email=document.getElementById('travelerEmail').value;
        state.traveler.passport=document.getElementById('travelerPassport').value;
        state.step++;render();
      };break;
    case 4:
      document.getElementById('iosDateField').onclick=function(){showDatePicker(state.residence.departure,date=>{state.residence.departure=date;render();});};
      document.getElementById('residenceNextBtn').onclick=()=>{
        state.residence.country=document.getElementById('residenceCountry').value;state.step++;render();
      };break;
    case 5:
      document.getElementById('membershipJoinBtn').onclick=()=>{state.memberEmail=document.getElementById('memberEmail').value;state.step++;render();};
      document.getElementById('membershipSkipBtn').onclick=()=>{state.memberEmail="";state.step++;render();};break;
    case 6:
      document.getElementById('scanReceiptBtn').onclick=()=>{state.receipts.push({number:''+(10000+Math.floor(Math.random()*90000)),amount:Math.floor(Math.random()*100+65),store:'NEWSTORE'});render();};
      document.getElementById('receiptsNextBtn').onclick=()=>{state.step++;render();};break;
    case 7:
      document.getElementById('refundCCBtn').onclick=()=>{state.refund='Credit Card';state.step++;render();};
      document.getElementById('refundWalletBtn').onclick=()=>{state.refund='Digital Wallet';state.step++;render();};
      document.getElementById('refundCashBtn').onclick=()=>{state.refund='Cash';state.step++;render();};break;
    case 8:
      if(state.refund==="Credit Card"&&document.getElementById('scanCardBtn')){
        document.getElementById('scanCardBtn').onclick=function(){
          showCardModal(res=>{
            state.card.pan=(res.cardNumber||"").replace(/\s+/g,"");
            state.card.expiry=res.expiry?res.expiry.replace(/(\d{2})\/?(\d{2,4})/,'$1/$2'):"";
            state.card.name=[res.firstName||"",res.lastName||""].join(" ").trim();
            render();
          });
        };}
      if(document.getElementById('cccvv')){document.getElementById('cccvv').oninput=e=>{state.card.ccv=e.target.value;} }
      document.getElementById('refundNextBtn').onclick=()=>{state.step++;render();};break;
    case 9:
      document.getElementById('agreeCheck').onchange=e=>{state.agreed = e.target.checked;}
      document.getElementById('showTermsLink').onclick=e=>{e.preventDefault();showPopup("Terms & Conditions","Standard T&C.<br/>For demo purposes.");};
      document.getElementById('showDeclarationLink').onclick=e=>{e.preventDefault();showPopup("Traveler Declaration","I confirm I'm not an EU resident, am above 16, and purchases will leave the EU.");};
      document.getElementById('submitBtn').onclick=()=>{if(!state.agreed)return alert("Please accept the Terms & Conditions and Traveler Declaration.");state.step=11;render();};break;
    case 10:
      document.getElementById('approveBtn').onclick=()=>{state.assistantApproved=true;state.step=11;render();};
      document.getElementById('rejectBtn').onclick=()=>{state.assistantApproved=false;state.step=0;render();};break;
    case 11: document.getElementById('finishBtn').onclick=()=>{state.step=12;render();};break;
  }
}
window.showReceipt=function(i){const r=state.receipts[i],modalBg=document.getElementById("modalBg");modalBg.style.display="block";const popup=document.createElement("div");popup.className="popup";popup.innerHTML=`<h3 style="margin-top:0">Receipt #${r.number}</h3><table><tr><td>Store:</td><td>${r.store}</td></tr><tr><td>Amount:</td><td>€${r.amount}</td></tr><tr><td>Goods:</td><td>Example Goods</td></tr><tr><td>Quantity:</td><td>1</td></tr></table><button class="btn-primary" id="closeReceiptBtn" style="margin-top:18px">Close</button>`;document.body.appendChild(popup);document.getElementById("closeReceiptBtn").onclick=cls;function cls(){document.body.removeChild(popup);modalBg.style.display="none";}modalBg.onclick=cls;};
function getSummaryText() {
  return [
    `Language: ${state.language}`,
    `Name: ${state.traveler.name}`,
    `Address: ${state.traveler.address}`,
    `Email: ${state.traveler.email}`,
    `Passport/ID: ${state.traveler.passport}`,
    state.qrData ? `Scanned QR: ${state.qrData}` : "",
    `Residence: ${state.residence.country}`,
    `Departure: ${state.residence.departure}`,
    `Refund: ${state.refund}`,
    state.refund === "Credit Card" ?
    [
      `CC Number: ${state.card.pan}`,
      `Exp: ${state.card.expiry}`,
      `Name: ${state.card.name}`,
      `CVV: ${state.card.ccv||"[not filled]"}`
    ].join('\n') : "",
    `Receipts: ${state.receipts.length}`
  ].filter(Boolean).join('\n');
}
render();
</script>
</body>
</html>
