<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Local Grey Kiosk - UI as per Screenshot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root {
      --blue: #0063b0;
      --header-radius: 12px;
      --max-card-width: 800px;
      --input-grey: #f4f6f9;
    }
    html, body { background: var(--blue); margin: 0; min-height: 100vh; }
    body { font-family: "SF Pro Display", Arial, sans-serif; color: #232b39;}
    .responsive-outer {
      background: #fff;
      min-height: 100vh;
      width: 100vw;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 54px 0 54px 0;
    }
    .main-card {
      background: #fff;
      border-radius: var(--header-radius);
      box-shadow: 0 8px 44px #01539928;
      max-width: var(--max-card-width);
      width: 100%;
      min-width: 340px;
      display: flex;
      flex-direction: column;
      margin: 0 24px;
    }
    .app-header {
      background: var(--blue);
      color: #fff;
      padding: 10px 0 10px 0;
      text-align: center;
      font-size: 2.55rem;
      font-weight: bold;
      border-radius: var(--header-radius) var(--header-radius) 0 0;
      letter-spacing: .01em;
    }
    .form-area {
      padding: 20px 20px 20px 20px;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    @media (max-width:900px) {
      .main-card { max-width: 99vw; }
      .form-area { padding: 10px 11px 10px 11px; }
    }
    @media (max-width:600px) {
      .main-card, .form-area, .app-header { border-radius: 0; }
      .form-area { padding: 8vw 2vw 8vw 2vw; }
    }
    label {
      color: var(--blue);
      font-weight: bold;
      font-size: 1.15em;
      margin: 0 0 10px 0;
      display: block;
    }
    .input-wrap { margin-bottom: 5px; width: 100%;}
    .picker-input {
      width: 90%; border-radius: 16px;
      font-size: 1.3em; background: #f4f6f9;
      padding: 10px 10px 10px 10px; border: 1.4px solid #cbcfdb;
      font-weight:bold; display: flex;
      align-items: center; justify-content: space-between; cursor:pointer;
    }
    .picker-arrow { font-size: 2em; color: #0b4289; user-select: none;}
    .input {
      font-size: 1.28em; background: #f4f6f9;
      border: 1.3px solid #c1cbdd;
      border-radius: 15px;
      padding: 17px 17px 17px 17px;
      margin-bottom: 10px;
      font-weight: bold;
      width: 100%; box-sizing: border-box;
    }
    .btn-main {
      margin-top: 10px; background: var(--blue);
      color: #fff; border: none; width: 100%;
      padding: 10px 10px 10px 10px;
      font-size: 2.0rem; font-weight: bold;
      border-radius: 24px;
      box-shadow: 0 2px 22px #00336612;
      letter-spacing: 0.03em;
      cursor: pointer; margin-bottom: 17px;
      display: block;
    }
    .btn-main:active { background: #00549c;}
    .btn-secondary {
      margin-top: 5px; background: #fff; color: var(--blue); border: 2px solid var(--blue);
      font-size: 1.13em; border-radius: 18px; font-weight: 700;
      padding: 10px 10px 10px 10px; box-shadow: none; margin-bottom: 13px; cursor: pointer; width: 100%;
    }
    .card {
      background: #e6f0fa;
      border-radius: 18px;
      padding: 10px 10px 10px 10px;
      font-size: 1.15rem;
      margin: 0 0 36px 0;
      box-shadow: 0 2px 13px #188bce17;
    }
    .receipt-list {
      background: #f4f6f9;
      border-radius: 16px;
      padding: 15px 12px 12px 12px;
      margin-bottom: 17px;
    }
    .receipt {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 5px #0054A622;
      padding: 13px 17px;
      margin-bottom: 12px;
      display:flex;justify-content:space-between;align-items:center;font-size:1.08rem;
    }
    video {
      display: block; width: 100%; max-width: 100%;
      border-radius: 17px; margin: 0 0 23px 0; background: #f4f7fa;
      box-sizing: border-box;
    }
    .modal-bg, .overlay {
      background: rgba(0,50,140,.09);
      position: fixed; top:0;left:0;right:0;bottom:0; z-index: 10010;
    }
    .popup, .picker-modal, .qr-modal, .date-modal {
      position: fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      z-index: 10090; background: #fff; border-radius: 18px; box-shadow: 0 8px 50px #39466a1c;
      min-width:320px; max-width:97vw; min-height:110px;
      padding:34px 30px 33px 28px; font-size: 1.08em;
    }
    #reader > video, .qr-modal video { border-radius: 13px !important; }
    .qr-close { background:var(--blue); color:#fff; border:none; border-radius:10px;
      font-size:1.1em; font-weight:700; padding:12px 44px; cursor:pointer;
      margin-top:20px; margin-bottom:0;}
    .qr-close:hover { background:#004981;}
  </style>
</head>
<body>
  <div class="responsive-outer">
    <div class="main-card">
      <div class="app-header">Local Grey</div>
      <div class="form-area" id="ui-content"></div>
    </div>
  </div>
  <div id="modalBg" class="modal-bg" style="display:none"></div>
  <script>
    // -- Kiosk State
    const state = {
      step: 0,
      language: "English",
      passport: "",
      qrData: "",
      traveler: { name: "", address: "", email: "", passport: "" },
      residence: { country: "", departure: "" },
      memberEmail: "",
      receipts: [
        {number: '12345', amount: 150, store: 'PRINTEMPS'},
        {number: '23456', amount: 87, store: 'Lafayette'},
        {number: '42407', amount: 224, store: 'ZARA'}
      ],
      refund: "",
      agreed: false,
      needAssistant: false,
      assistantApproved: false
    };
    const languages = ["English","Mandarin","Hindi","Spanish","French","Arabic","Bengali","Russian","Portuguese","Urdu","Indonesian","German","Japanese","Swahili","Marathi","Telugu","Turkish","Korean","Vietnamese","Italian"];
    // ----------- Template Functions for each step below (same as prior, matching your workflow) -----------
    function render() {
      const s = state, step = s.step, $c = d=>document.getElementById(d);
      let html = '';
      if (step===0) html = `
        <label>Select your language</label>
        <div class="input-wrap">
          <div class="picker-input" id="langPickerBtn">
            <span>${s.language}</span>
            <span class="picker-arrow">&#9662;</span>
          </div>
        </div>
        <button class="btn-main" id="langNextBtn">Next</button>
      `;
      else if (step===1) html = `
        <h2>Have your documents ready</h2>
        <div class="card">
          <ul>
            <li>Passport or ID</li>
            <li>Sales Receipts</li>
            <li>Credit Card or eWallet</li>
          </ul>
          <span class="elig">Eligibility:</span>
          <ul>
            <li>16 years old or older</li>
            <li>Not a European Union resident</li>
            <li>Get Customs validation within 3 months of issuance</li>
          </ul>
        </div>
        <button class="btn-main" id="docNextBtn">Next</button>
      `;
      else if (step===2) html = `
        <h2>Passport/ID Scanning</h2>
        <video id="passportVideo" controls autoplay playsinline muted poster="https://dummyimage.com/900x250/cccccc/222222&text=Passport+Scan">
          <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4"/>
        </video>
        <label for="passportInput">Type your Passport or ID number</label>
        <input class="input" id="passportInput" placeholder="Passport or ID Number" value="${s.passport||''}">
        <button id="qrbtn" class="btn-secondary">Scan QR code</button>
        <button class="btn-main" id="passportNextBtn">Continue</button>
      `;
      else if (step===3) html = `
        <h2>Traveler Information</h2>
        <input class="input" id="travelerName" placeholder="Full Name" value="${s.traveler?.name||''}"/>
        <input class="input" id="travelerAddress" placeholder="Address" value="${s.traveler?.address||''}"/>
        <input class="input" id="travelerEmail" type="email" placeholder="Email" value="${s.traveler?.email||''}"/>
        <input class="input" id="travelerPassport" placeholder="Passport/ID Number" value="${s.traveler?.passport||s.passport||''}"/>
        <button class="btn-main" id="travelerNextBtn">Next</button>
      `;
      else if (step===4) html = `
        <h2>Residence & Departure</h2>
        <input class="input" id="residenceCountry" placeholder="Country of Residence" value="${s.residence?.country||''}"/>
        <div class="input-wrap">
          <div class="picker-input" id="datePickerBtn">
            <span>${s.residence?.departure ? s.residence.departure : "Select departure date"}</span>
            <span class="picker-arrow">&#128197;</span>
          </div>
        </div>
        <button class="btn-main" id="residenceNextBtn">Next</button>
      `;
      else if (step===5) html = `
        <h2>Become a Member (optional)</h2>
        <input class="input" id="memberEmail" placeholder="Email" value="${s.memberEmail||''}" />
        <button class="btn-main" id="membershipJoinBtn">Join</button>
        <button class="btn-secondary" id="membershipSkipBtn">Skip</button>
      `;
      else if (step===6) html = `
        <h2>Your Receipts</h2>
        <div class="receipt-list" id="receiptsList">${s.receipts.map((r,i)=>`<div class="receipt"><span>Receipt #${r.number}, €${r.amount}, Store: ${r.store}</span>
        <button class="btn-secondary" style="width:auto;padding:4px 12px" onclick="window.showReceipt(${i})">View</button></div>`).join('')}</div>
        <button class="btn-secondary" id="scanReceiptBtn">Scan New Receipt</button>
        <button class="btn-main" id="receiptsNextBtn">Next</button>
      `;
      else if (step===7) html = `
        <h2>Choose Refund Method</h2>
        <button class="btn-main" id="refundCCBtn">Credit Card</button>
        <button class="btn-main" id="refundWalletBtn">Digital Wallet</button>
        <button class="btn-main" id="refundCashBtn">Cash</button>
      `;
      else if (step===8) html = `
        <h2>Refund Instructions</h2>
        <video id="refundVideo" controls autoplay playsinline muted poster="https://dummyimage.com/900x250/cccccc/222222&text=Refund+Instructions">
          <source src="https://www.w3schools.com/html/movie.mp4" type="video/mp4"/>
        </video>
        <p>Refund by: <b>${s.refund||''}</b>.</p>
        <button class="btn-main" id="refundNextBtn">Continue</button>
      `;
      else if (step===9) html = `
        <h2>Summary & Traveler Declaration</h2>
        <textarea readonly style="font-size:1.08em">${getSummaryText(s)}</textarea>
        <label class="checkbox-label">
          <input id="agreeCheck" type="checkbox" ${s.agreed?"checked":""}/>
          I accept <button class="linkbtn" id="showTermsLink">Terms & Conditions</button> and <button class="linkbtn" id="showDeclarationLink">Traveler Declaration</button>
        </label>
        <button class="btn-main" id="submitBtn">Submit</button>
      `;
      else if (step===10) html = `
        <h2>Assistance Required</h2>
        <input class="input" id="assistantInput" placeholder="Scan assistant QR code">
        <div style="display:flex;gap:15px;margin-top:22px;">
          <button class="btn-main" id="approveBtn" style="flex:1">Approve</button>
          <button class="btn-secondary" id="rejectBtn" style="flex:1">Reject</button>
        </div>
      `;
      else html = `
        <div style="text-align:center;margin-top:54px;">
          <h2>Enjoy your journey!</h2>
          <div style="font-size:21px;color:#0054A699;margin:25px;">Thank you!</div>
      </div>`;
      document.getElementById('ui-content').innerHTML = html;
      // STEP FLOW LOGIC:
      if (step===0) {
        document.getElementById('langPickerBtn').onclick = function(){
          showPickerModal(s.language,lang=>{s.language=lang;render();});
        };
        document.getElementById('langNextBtn').onclick=()=>{s.step++;render();};
      } else if (step===1) {
        document.getElementById('docNextBtn').onclick=()=>{s.step++;render();};
      } else if (step===2) {
        document.getElementById('passportNextBtn').onclick=()=>{
          s.passport=document.getElementById('passportInput').value.trim();
          s.traveler.passport=s.passport;s.step++;render();
        };
        document.getElementById('qrbtn').onclick=function(){
          showQrModal(code=>{
            s.passport = code;
            s.qrData = code;
            render();
            setTimeout(()=>{document.getElementById('passportInput').value=s.passport;},80);
          });
        };
        setTimeout(()=>{try{document.getElementById('passportVideo').play();}catch(e){}},300);
      } else if (step===3) {
        document.getElementById('travelerNextBtn').onclick=()=>{
          s.traveler.name=document.getElementById('travelerName').value;
          s.traveler.address=document.getElementById('travelerAddress').value;
          s.traveler.email=document.getElementById('travelerEmail').value;
          s.traveler.passport=document.getElementById('travelerPassport').value;
          s.step++;render();
        };
      } else if (step===4) {
        document.getElementById('datePickerBtn').onclick=function(){
          showDatePicker(s.residence.departure,date=>{s.residence.departure=date;render();});
        };
        document.getElementById('residenceNextBtn').onclick=()=>{
          s.residence.country=document.getElementById('residenceCountry').value;
          s.step++;render();
        };
      } else if (step===5) {
        document.getElementById('membershipJoinBtn').onclick=()=>{s.memberEmail=document.getElementById('memberEmail').value;s.step++;render();};
        document.getElementById('membershipSkipBtn').onclick=()=>{s.memberEmail="";s.step++;render();};
      } else if (step===6) {
        document.getElementById('scanReceiptBtn').onclick=()=>{
          s.receipts.push({number:''+(10000+Math.floor(Math.random()*90000)),amount:Math.floor(Math.random()*100+65),store:'NEWSTORE'});render();
        };
        document.getElementById('receiptsNextBtn').onclick=()=>{s.step++;render();};
      } else if (step===7) {
        document.getElementById('refundCCBtn').onclick=()=>{s.refund='Credit Card';s.step++;render();};
        document.getElementById('refundWalletBtn').onclick=()=>{s.refund='Digital Wallet';s.step++;render();};
        document.getElementById('refundCashBtn').onclick=()=>{s.refund='Cash';s.step++;render();};
      } else if (step===8) {
        setTimeout(()=>{try{document.getElementById('refundVideo').play();}catch(e){}},220);
        document.getElementById('refundNextBtn').onclick=()=>{s.step++;render();};
      } else if (step===9) {
        document.getElementById('agreeCheck').onchange=e=>{s.agreed = e.target.checked;}
        document.getElementById('showTermsLink').onclick=e=>{e.preventDefault();showPopup("Terms & Conditions","Standard T&C.<br/>For demo purposes.");};
        document.getElementById('showDeclarationLink').onclick=e=>{e.preventDefault();showPopup("Traveler Declaration","I confirm I'm not an EU resident, am above 16, and purchases will leave the EU.");};
        document.getElementById('submitBtn').onclick=()=>{if(!s.agreed)return alert("Please accept the Terms & Conditions and Traveler Declaration.");s.step++;render();};
      } else if (step===10) {
        document.getElementById('approveBtn').onclick=()=>{s.assistantApproved=true;s.step++;render();};
        document.getElementById('rejectBtn').onclick=()=>{s.assistantApproved=false;s.step=0;render();};
      } else if (step===11) {
        setTimeout(()=>{try{document.getElementById('taxVideo').play();}catch(e){}},240);
        document.getElementById('finishBtn').onclick=()=>{s.step++;render();};
      }
    }
    // -- Picker and QR functions as before --
    function showPickerModal(curr, cb) {
      const modalBg = document.getElementById('modalBg'); modalBg.style.display="block";
      let idx = languages.indexOf(curr); if(idx<0)idx=0;
      const modal = document.createElement('div');
      modal.className='picker-modal';
      modal.innerHTML = `<h3 style="margin-bottom:18px;">Select your language</h3>
        <div style="height:200px;overflow-y:scroll;">
        ${languages.map((lang,i)=>`<div style="padding:15px;font-size:1.17em;border-radius:9px;margin:2px 0;cursor:pointer;background:${i==idx?'#eef6ff':'#fff'};color:${i==idx?'#065ca1':'#233'};" data-i="${i}">${lang}</div>`).join('')}
        </div>
        <button class="btn-main" style="margin-top:20px;margin-bottom:3px;font-size:1.1em;" id="pickLangBtn">OK</button>`;
      document.body.appendChild(modal);
      let picked = idx;
      Array.from(modal.querySelectorAll('[data-i]')).forEach(el=>{
        el.onclick=e=>{
          picked=+el.dataset.i;
          Array.from(modal.querySelectorAll('[data-i]')).forEach(o=>o.style.background='#fff');
          el.style.background='#eef6ff';
        }
      });
      modal.querySelector('#pickLangBtn').onclick = ()=>{cb(languages[picked]); cls();}
      function cls(){document.body.removeChild(modal);modalBg.style.display="none";}
      modalBg.onclick=cls;
    }
    function showDatePicker(curr, cb) {
      const modalBg=document.getElementById("modalBg");modalBg.style.display="block";
      let now=new Date(),v=(curr||'').split('-');let y=+v[0]||now.getFullYear(),m=+v[1]||now.getMonth()+1,d=+v[2]||now.getDate();
      let years=[],months=[],days=[];for(let i=now.getFullYear()-1;i<=now.getFullYear()+3;i++) years.push(i);for(let i=1;i<=12;i++) months.push(i);
      function updateDays(yy,mm){days=[];for(let i=1;i<=new Date(yy,mm,0).getDate();i++)days.push(i);}
      updateDays(y,m);
      const modal=document.createElement('div');modal.className="picker-modal";
      modal.innerHTML=`
        <h3 style="margin-bottom:18px">Select departure date</h3>
        <div style="display:flex;gap:15px;justify-content:center;">
          <div style="flex:1;min-width:60px;"><div style="height:120px;overflow-y:scroll;"><ul class="date-years">${years.map(yy=>`<li class="date-item${yy===y?' selected':''}" data-val="${yy}">${yy}</li>`).join('')}</ul></div></div>
          <div style="flex:1;min-width:60px;"><div style="height:120px;overflow-y:scroll;"><ul class="date-months">${months.map(mm=>`<li class="date-item${mm===m?' selected':''}" data-val="${mm}">${String(mm).padStart(2,'0')}</li>`).join('')}</ul></div></div>
          <div style="flex:1;min-width:60px;"><div style="height:120px;overflow-y:scroll;"><ul class="date-days">${days.map(dd=>`<li class="date-item${dd===d?' selected':''}" data-val="${dd}">${String(dd).padStart(2,'0')}</li>`).join('')}</ul></div></div>
        </div>
        <button class="btn-main" style="margin-top:18px;" id="pickDateBtn">OK</button>
      `;
      document.body.appendChild(modal);
      function findIdx(list){return Array.from(list.children).findIndex(li=>li.classList.contains('selected'));}
      modal.querySelector('#pickDateBtn').onclick=()=>{
        let idxY=findIdx(modal.querySelector('.date-years')),idxM=findIdx(modal.querySelector('.date-months')),idxD=findIdx(modal.querySelector('.date-days'));
        cb(`${years[idxY]}-${String(months[idxM]).padStart(2,'0')}-${String(days[idxD]).padStart(2,'0')}`);cls();
      };
      function cls(){document.body.removeChild(modal);modalBg.style.display="none";}
      modalBg.onclick=cls;
    }
    function showQrModal(onScan) {
      if(window.qrScannerActive)return;window.qrScannerActive=true;
      const modalBg=document.getElementById("modalBg");modalBg.style.display="block";
      let qrdiv = document.createElement("div");
      qrdiv.className = "qr-modal";
      qrdiv.innerHTML = `<div id="reader" style="width:99vw;max-width:320px"></div><button class="qr-close" id="qrCloseBtn">Close</button>`;
      document.body.appendChild(qrdiv);
      let qr=new Html5Qrcode("reader");
      qr.start({facingMode:"environment"},{fps:10,qrbox:220},code=>{
        onScan(code);
        qr.stop();
        document.body.removeChild(qrdiv);
        modalBg.style.display="none";
      },()=>{});
      document.getElementById('qrCloseBtn').onclick=()=>{qr.stop();document.body.removeChild(qrdiv);modalBg.style.display="none";}
      modalBg.onclick=()=>{qr.stop();document.body.removeChild(qrdiv);modalBg.style.display="none";}
    }
    function showPopup(title, html) {
      const modalBg = document.getElementById("modalBg");
      modalBg.style.display = "block";
      const popup=document.createElement("div");
      popup.className="popup";
      popup.innerHTML =
        `<h3 style="margin-top:0;margin-bottom:15px">${title}</h3><div style="margin-bottom:22px">${html}</div><button class="btn-main" id="closePopupBtn" style="margin-top:10px;font-size:1rem;">Close</button>`;
      document.body.appendChild(popup);
      document.getElementById("closePopupBtn").onclick = cls;modalBg.onclick=cls;
      function cls(){document.body.removeChild(popup);modalBg.style.display="none";}
    }
    window.showReceipt=function(i){
      const r=state.receipts[i],modalBg=document.getElementById("modalBg");modalBg.style.display="block";
      const popup=document.createElement("div");
      popup.className="popup";
      popup.innerHTML=`<h3 style="margin-top:0">Receipt #${r.number}</h3><table>
      <tr><td>Store:</td><td>${r.store}</td></tr>
      <tr><td>Amount:</td><td>€${r.amount}</td></tr>
      <tr><td>Goods:</td><td>Example Goods</td></tr>
      <tr><td>Quantity:</td><td>1</td></tr>
      </table><button class="btn-main" id="closeReceiptBtn" style="margin-top:18px;font-size:1rem;">Close</button>`;
      document.body.appendChild(popup);
      document.getElementById("closeReceiptBtn").onclick=cls;modalBg.onclick=cls;
      function cls(){document.body.removeChild(popup);modalBg.style.display="none";}
    };

    // Initial render
    state.step = 0;
    render();
  </script>
</body>
</html>
