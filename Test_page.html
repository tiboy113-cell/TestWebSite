<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Local Grey Kiosk Demo (Fixes, Responsive, QR, UI)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    html, body { background: #eaf0fa; min-height: 100vh; margin:0; }
    body { font-family: "SF Pro Display", Arial, sans-serif; color: #222; margin: 0; }
    .responsive-outer {
      min-height: 100vh; padding: 10px;
      display: flex; justify-content: center; align-items: flex-start;
      background: #eaf0fa;
    }
    .app-container {
      max-width: 928px; width:100%;
      border-radius: 28px;
      background: #fff;
      box-shadow: 0 8px 36px #0054a655, 0 1.5px 4px #555a6211;
      padding: 0;
    }
    .app-header {
      background: #555A62;
      color: white;
      padding: 38px 0 32px 0;
      text-align: center;
      font-size: 2.2rem;
      font-weight: bold;
      letter-spacing: .02em;
      border-radius: 28px 28px 0 0;
    }
    /* Card/content look */
    .screen {
      width: 100%; min-height: 450px;
      background: #fff; border-radius: 0 0 28px 28px;
      box-sizing: border-box;
      padding: 42px 34px 28px 34px;
    }
    .card {
      background: #e6f0fa;
      border-radius: 17px;
      padding: 18px 19px 15px 20px;
      margin: 0 0 30px 0;
      font-size: 1.1rem;
      box-shadow: 0 2px 11px #0054a613;
    }
    h2 {
      margin: 0 0 26px 0; font-size: 2rem; color: #0054A6; font-weight: 700;
    }
    ul { padding-left: 27px; margin: 0 0 12px 0;}
    .elig { font-weight: bold; margin-top:10px; margin-bottom: 5px; }
    label { font-weight: 600; color: #154274; margin-top:1.3em; margin-bottom:.5em; display: block;}
    .input-row {margin-bottom:18px;}
    .input-label {margin-bottom: 7px; font-weight: 700; color: #0054A6; display:block;}
    input, select, textarea, .picker-input {
      width: 100%; min-width:0; box-sizing: border-box;
      padding: 18px;
      font-size: 1.19rem;
      border: 1.5px solid #cbcfd6;
      border-radius: 15px; margin-bottom: 6px;
      transition: border .14s;
    }
    input:focus, select:focus, textarea:focus, .picker-input:focus { border-color: #0054A6; background: #e6f0fa;}
    textarea {min-height: 74px;}
    .btn-primary, .btn-secondary {
      display: block; width: 100%; border: none;
      border-radius: 21px;
      padding: 20px 0;
      font-size: 1.25rem; font-weight: 800; box-shadow: 0 2px 8px #0054a61A;
      transition: background .14s;
      margin-top: 40px;
    }
    .btn-primary {
      background: #0054A6; color: #fff; margin-bottom: 16px;
      letter-spacing: 0.01em;
    }
    .btn-primary:active { background: #003366; }
    .btn-secondary {
      background:#fff; color: #0054A6; border: 2px solid #0054A6;
      box-shadow: none; margin-top: 0; margin-bottom: 6px;
    }
    /* receipts */
    .receipt-list {
      background: #f4f6f9; border-radius: 16px; padding: 11px 7px 7px 7px; margin-bottom: 13px;
    }
    .receipt {
      background: #fff; border-radius: 13px; box-shadow: 0 1px 6px #0054A622;
      padding: 12px 17px; margin-bottom: 9px; display:flex;justify-content:space-between; align-items:center;font-size:1.09rem;
    }
    /* Modal overlays - always on top */
    .modal-bg,.overlay {background:rgba(0,50,140,.13);position:fixed;top:0;left:0;right:0;bottom:0;z-index: 10010;}
    .popup,.modal,.picker-modal,.qr-modal,.date-modal {
      position:fixed;z-index:10020;left:50%;top:50%;transform:translate(-50%,-50%);
      background:#fff;border-radius:18px;box-shadow:0 6px 38px #0054A661;
      padding:30px 28px 30px 28px;max-width:99vw;min-width:330px;
      display:flex;flex-direction:column;align-items:stretch;
      min-height:120px;
    }
    .popup h3, .modal h3 {margin-top:0;}

    /* QR & picker modal style: override html5-qrcode defaults & iOS pickers */
    #reader>video, .qr-modal video { border-radius: 14px !important;}
    .qr-close {background:#0054A6;color:#fff;border:none;border-radius:9px;font-size:1.21em;font-weight:700;padding:11px 37px;margin-top:18px;cursor:pointer;margin-bottom:0;}
    .qr-close:hover {background:#003366;}
    /* Stepper: Center blocks on wide */
    @media (min-width:1000px){
      .app-container{max-width:928px;}
      .screen {padding:48px 110px 32px 110px;}
      .card {margin:0 0 36px 0;}
    }
    @media (max-width:700px) {
      .responsive-outer, .app-container, .screen,.popup,.modal { border-radius:0; }
      .responsive-outer{padding:0;}
      .app-header{border-radius:0;}
      .card,.receipt-list{padding-left:5px;padding-right:5px;}
      .screen{padding:14px 0 7px 0;}
      .btn-primary, .btn-secondary { padding: 18px 0; margin-top:33px;}
    }
  </style>
</head>
<body>
  <div class="responsive-outer">
    <div class="app-container">
      <div class="app-header">Local Grey</div>
      <div id="flow"></div>
    </div>
  </div>
  <div id="modalBg" class="modal-bg" style="display:none"></div>
  <script>
const state = {
  step: 0,
  language: "English",
  passport: "",
  qrData: "",
  traveler: { name: "", address: "", email: "", passport: "" },
  residence: { country: "", departure: "" },
  memberEmail: "",
  receipts: [
    {number: '12345', amount: 150, store: 'PRINTEMPS'},
    {number: '23456', amount: 87, store: 'Lafayette'},
    {number: '42407', amount: 224, store: 'ZARA'},
    {number: '59234', amount: 54, store: 'Carrefour'},
    {number: '13090', amount: 68, store: 'Starbucks'},
    {number: '99123', amount: 300, store: 'Galeries'},
    {number: '77222', amount: 25, store: 'Uniqlo'},
    {number: '81654', amount: 178, store: 'Apple Store'}
  ],
  refund: "",
  agreed: false,
  needAssistant: false,
  assistantApproved: false
};
const languages = ["English","Mandarin","Hindi","Spanish","French","Arabic","Bengali","Russian","Portuguese","Urdu","Indonesian","German","Japanese","Swahili","Marathi","Telugu","Turkish","Korean","Vietnamese","Italian"];
function showPickerWheel(current, callback) {
  const modalBg = document.getElementById("modalBg"); modalBg.style.display = "block";
  let idx = languages.indexOf(current); if(idx<0)idx=0;
  const modal = document.createElement('div');
  modal.className = "picker-modal";
  modal.innerHTML = `
    <h3 style="margin-bottom:18px;">Select your language</h3>
    <div style="height:212px;overflow:hidden;position:relative;">
      <div style="height:38px;width:100%;border-radius:10px;position:absolute;left:0;top:97px;border:2px solid #0054A6;background:rgba(0,84,166,.07);z-index:2;"></div>
      <div style="height:212px;overflow-y:scroll;scroll-behavior:smooth;">
      <ul style="list-style:none;padding:0;margin:0;">
      ${languages.map((lang, i) => `<li class="picker-item${i==idx?' selected':''}" data-idx="${i}" style="height:38px;line-height:38px;text-align:center;cursor:pointer;font-size:1.12em;color:#174699;margin:0 8px;border-radius:8px;">${lang}</li>`).join('')}
      </ul>
      </div>
    </div>
    <button class="btn-primary" style="margin-top:20px;margin-bottom:3px;" id="pickLangBtn">OK</button>
  `;
  document.body.appendChild(modal);
  const items = modal.querySelectorAll('.picker-item');
  const wheel = modal.querySelector('div[style*="overflow-y:scroll"]');const h=38;
  let pickIdx = idx;
  setTimeout(()=>{wheel.scrollTop=idx*h;hl();},20);
  function hl(x){let idx=Math.round(wheel.scrollTop/h);if(idx<0)idx=0;if(idx>languages.length-1)idx=languages.length-1;items.forEach((it,i)=>it.classList.toggle('selected',i==idx));pickIdx = idx;}
  wheel.addEventListener('scroll',()=>{hl();});
  modal.querySelector('ul').onclick=e=>{if(e.target.classList.contains('picker-item')){pickIdx=Number(e.target.dataset.idx);hl(true,true)}};
  modal.querySelector('#pickLangBtn').onclick=()=>{callback(languages[pickIdx]);cls();}
  function cls(){document.body.removeChild(modal);modalBg.style.display="none";document.getElementById('langPickerBtn')?.focus();}
  modalBg.onclick=cls;
}
function showDatePicker(current, callback) {
  const modalBg=document.getElementById("modalBg");modalBg.style.display="block";
  let now=new Date(),v=(current||'').split('-');let y=+v[0]||now.getFullYear(),m=+v[1]||now.getMonth()+1,d=+v[2]||now.getDate();
  let years=[],months=[],days=[];for(let i=now.getFullYear()-1;i<=now.getFullYear()+3;i++) years.push(i);for(let i=1;i<=12;i++) months.push(i);
  function updateDays(yy,mm){days=[];for(let i=1;i<=new Date(yy,mm,0).getDate();i++)days.push(i);}
  updateDays(y,m);
  const modal=document.createElement('div');modal.className="picker-modal";
  modal.innerHTML=`
    <h3 style="margin-bottom:18px">Select departure date</h3>
    <div style="display:flex;gap:15px;justify-content:center;">
      <div style="flex:1;min-width:60px;"><div style="height:120px;overflow-y:scroll;"><ul class="date-years">${years.map(yy=>`<li class="date-item${yy===y?' selected':''}" data-val="${yy}">${yy}</li>`).join('')}</ul></div></div>
      <div style="flex:1;min-width:60px;"><div style="height:120px;overflow-y:scroll;"><ul class="date-months">${months.map(mm=>`<li class="date-item${mm===m?' selected':''}" data-val="${mm}">${String(mm).padStart(2,'0')}</li>`).join('')}</ul></div></div>
      <div style="flex:1;min-width:60px;"><div style="height:120px;overflow-y:scroll;"><ul class="date-days">${days.map(dd=>`<li class="date-item${dd===d?' selected':''}" data-val="${dd}">${String(dd).padStart(2,'0')}</li>`).join('')}</ul></div></div>
    </div>
    <button class="btn-primary" style="margin-top:18px;" id="pickDateBtn">OK</button>
  `;
  document.body.appendChild(modal);
  function findIdx(list){return Array.from(list.children).findIndex(li=>li.classList.contains('selected'));}
  modal.querySelector('#pickDateBtn').onclick=()=>{
    let idxY=findIdx(modal.querySelector('.date-years')),idxM=findIdx(modal.querySelector('.date-months')),idxD=findIdx(modal.querySelector('.date-days'));
    callback(`${years[idxY]}-${String(months[idxM]).padStart(2,'0')}-${String(days[idxD]).padStart(2,'0')}`);cls();
  };
  function cls(){document.body.removeChild(modal);modalBg.style.display="none";}
  modalBg.onclick=cls;
}
function showQrModal(onScan) {
  if(window.qrScannerActive)return;window.qrScannerActive=true;
  const modalBg=document.getElementById("modalBg");modalBg.style.display="block";
  let qrdiv = document.createElement("div");
  qrdiv.className = "qr-modal";
  qrdiv.innerHTML = `<div id="reader" style="width:99vw;max-width:320px"></div><button class="qr-close" id="qrCloseBtn">Close</button><div id="qrMsg" style="text-align:center;font-size:1.11em;color:#0054A6;margin-top:7px;"></div>`;
  document.body.appendChild(qrdiv);
  let qr=new Html5Qrcode("reader");
  qr.start({facingMode:"environment"},{fps:10,qrbox:220},code=>{
    onScan(code);
    qr.stop();
    document.body.removeChild(qrdiv);
    modalBg.style.display="none";
  },()=>{});
  document.getElementById('qrCloseBtn').onclick=()=>{qr.stop();document.body.removeChild(qrdiv);modalBg.style.display="none";}
  modalBg.onclick=()=>{qr.stop();document.body.removeChild(qrdiv);modalBg.style.display="none";}
}
function showPopup(title, html) {
  const modalBg = document.getElementById("modalBg");
  modalBg.style.display = "block";
  const popup=document.createElement("div");
  popup.className="popup";
  popup.innerHTML = `<h3 style="margin-top:0;margin-bottom:15px">${title}</h3><div style="margin-bottom:22px">${html}</div><button class="btn-primary" id="closePopupBtn" style="margin-top:10px">Close</button>`;
  document.body.appendChild(popup);
  document.getElementById("closePopupBtn").onclick = close;
  modalBg.onclick=close;
  function close() { document.body.removeChild(popup); modalBg.style.display="none";}
}
window.showReceipt=function(i){
  const r=state.receipts[i],modalBg=document.getElementById("modalBg");modalBg.style.display="block";
  const popup=document.createElement("div");
  popup.className="popup";
  popup.innerHTML=`<h3 style="margin-top:0">Receipt #${r.number}</h3><table>
  <tr><td>Store:</td><td>${r.store}</td></tr>
  <tr><td>Amount:</td><td>€${r.amount}</td></tr>
  <tr><td>Goods:</td><td>Example Goods</td></tr>
  <tr><td>Quantity:</td><td>1</td></tr>
  </table><button class="btn-primary" id="closeReceiptBtn" style="margin-top:18px">Close</button>`;
  document.body.appendChild(popup);
  document.getElementById("closeReceiptBtn").onclick=cls;modalBg.onclick=cls;
  function cls(){document.body.removeChild(popup);modalBg.style.display="none";}
};
function getSummaryText() {
  return [
    `Language: ${state.language}`,
    `Name: ${state.traveler.name}`,
    `Address: ${state.traveler.address}`,
    `Email: ${state.traveler.email}`,
    `Passport/ID: ${state.passport}`,
    state.qrData ? `QR Scanned: ${state.qrData}` : "",
    `Residence: ${state.residence.country}`,
    `Departure: ${state.residence.departure}`,
    `Refund: ${state.refund}`,
    `Receipts: ${state.receipts.length}`
  ].filter(Boolean).join('\n');
}
function render() {
  let html = '', $flow = document.getElementById('flow');
  if(state.step===0){
    html=`
      <div class="screen">
        <label class="picker-label">Select your language</label>
        <div class="input-row" style="margin-bottom:38px;">
          <button id="langPickerBtn" class="picker-input" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
            <span id="langVal" style="font-weight:bold;color:#2a4873;">${state.language}</span>
            <span aria-label="expand" style="font-size:1.6em;color:#255ba8;">&#9662;</span>
          </button>
        </div>
        <button class="btn-primary" id="langNextBtn">Next</button>
      </div>
    `;
  } else if(state.step===1){
    html=`<div class="screen">
      <h2>Have your documents ready</h2>
      <div class="card">
        <ul>
          <li>Passport or ID</li><li>Sales Receipts</li><li>Credit Card or eWallet</li>
        </ul>
        <span class="elig">Eligibility:</span>
        <ul>
          <li>16 years old or older</li>
          <li>Not a European Union resident</li>
          <li>Get Customs validation within 3 months of issuance</li>
        </ul>
      </div>
      <button class="btn-primary" id="docNextBtn">Next</button>
    </div>`;
  } else if(state.step===2){
    html=`<div class="screen">
      <h2>Passport/ID Scanning</h2>
      <video controls poster="https://assets-global.blue.com/videos/passport-scan.jpg">
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4"/>
      </video>
      <div class="input-row" style="margin-top:18px;">
        <label class="input-label" for="passportInput">Type your Passport or ID number</label>
        <input id="passportInput" type="text" placeholder="Passport or ID Number" value="${state.passport || ''}" autocomplete="off"/>
        <button id="qrbtn" type="button" class="btn-secondary" style="font-size:1.08em;">Scan QR code</button>
      </div>
      <button class="btn-primary" id="passportNextBtn">Continue</button>
    </div>`;
  } else if(state.step===3){
    html=`<div class="screen">
      <h2>Traveler Information</h2>
      <input id="travelerName" type="text" placeholder="Full Name" value="${state.traveler.name||''}"/>
      <input id="travelerAddress" type="text" placeholder="Address" value="${state.traveler.address||''}"/>
      <input id="travelerEmail" type="email" placeholder="Email" value="${state.traveler.email||''}"/>
      <input id="travelerPassport" type="text" placeholder="Passport/ID Number" value="${state.traveler.passport||state.passport||''}"/>
      <button class="btn-primary" id="travelerNextBtn">Next</button>
    </div>`;
  } else if(state.step===4){
    html=`<div class="screen">
      <h2>Residence & Departure</h2>
      <input id="residenceCountry" type="text" placeholder="Country of Residence" value="${state.residence.country||''}"/>
      <div class="input-row" style="margin-top:8px;">
        <button id="datePickerBtn" class="picker-input" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
          <span id="dateVal" style="font-weight:bold;color:#2a4873;">
            ${state.residence.departure ? state.residence.departure : "Select departure date"}
          </span>
          <span aria-label="expand" style="font-size:1.5em;color:#255ba8;">&#128197;</span>
        </button>
      </div>
      <button class="btn-primary" id="residenceNextBtn">Next</button>
    </div>`;
  } else if(state.step===5){
    html=`<div class="screen">
      <h2>Become a Member (optional)</h2>
      <input id="memberEmail" type="email" placeholder="Email" value="${state.memberEmail||''}" />
      <button class="btn-primary" id="membershipJoinBtn">Join</button>
      <button class="btn-secondary" id="membershipSkipBtn">Skip</button>
    </div>`;
  } else if(state.step===6){
    html=`<div class="screen">
      <h2>Your Receipts</h2>
      <div class="receipt-list" id="receiptsList">
        ${state.receipts.map((r,i)=>`<div class="receipt"><span>Receipt #${r.number}, €${r.amount}, Store: ${r.store}</span>
        <button class="btn-secondary" style="width:auto;padding:4px 12px" onclick="window.showReceipt(${i})">View</button></div>`).join('')}
      </div>
      <button class="btn-secondary" id="scanReceiptBtn">Scan New Receipt</button>
      <button class="btn-primary" id="receiptsNextBtn">Next</button>
    </div>`;
  } else if(state.step===7){
    html=`<div class="screen">
      <h2>Choose Refund Method</h2>
      <button class="btn-primary" id="refundCCBtn">Credit Card</button>
      <button class="btn-primary" id="refundWalletBtn">Digital Wallet</button>
      <button class="btn-primary" id="refundCashBtn">Cash</button>
    </div>`;
  } else if(state.step===8){
    html=`<div class="screen">
      <h2>Refund Instructions</h2>
      <video controls poster="https://assets-global.blue.com/videos/payment.jpg" style="margin-bottom:9px;">
        <source src="https://www.w3schools.com/html/movie.mp4" type="video/mp4"/>
      </video>
      <p>Refund by: <b>${state.refund||''}</b>. Please follow on-screen instructions to register your ${state.refund.toLowerCase()} for refund.</p>
      <button class="btn-primary" id="refundNextBtn">Continue</button>
    </div>`;
  } else if(state.step===9){
    html=`<div class="screen">
      <h2>Summary & Traveler Declaration</h2>
      <textarea readonly style="font-size:1.08em">${getSummaryText()}</textarea>
      <label class="checkbox-label">
        <input id="agreeCheck" type="checkbox" ${state.agreed?"checked":""}/>
        I accept <button class="linkbtn" id="showTermsLink">Terms & Conditions</button> and <button class="linkbtn" id="showDeclarationLink">Traveler Declaration</button>
      </label>
      <button class="btn-primary" id="submitBtn">Submit</button>
    </div>`;
  } else if(state.step===10){
    html=`<div class="screen"><h2>Assistance Required</h2>
    <p>A shop assistant will help you soon.</p>
    <input id="assistantInput" type="text" placeholder="Scan assistant QR code">
    <div style="display:flex;gap:15px;margin-top:20px;">
      <button class="btn-primary" id="approveBtn" style="flex:1">Approve</button>
      <button class="btn-secondary" id="rejectBtn" style="flex:1">Reject</button>
    </div></div>`;
  } else if(state.step===11){
    html=`<div class="screen">
      <h2>Collect your Tax Free Form</h2>
      <video controls poster="https://assets-global.blue.com/videos/taxfree_form.jpg">
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4"/>
      </video>
      <div class="card">Remember to complete Customs validation at departure!</div>
      <button class="btn-primary" id="finishBtn">Finish</button>
    </div>`;
  } else if(state.step===12){
    html=`<div class="screen" style="text-align:center;">
      <h2>Enjoy your journey!</h2>
      <div style="font-size:21px;color:#0054A699;margin:25px;">Thank you!</div>
    </div>`;
  }
  $flow.innerHTML=html;
  switch(state.step){
    case 0:
      document.getElementById('langPickerBtn').onclick=function(){
        showPickerWheel(state.language,lang=>{state.language=lang;render();});
      };
      document.getElementById('langNextBtn').onclick=()=>{state.step++;render();};break;
    case 1: document.getElementById('docNextBtn').onclick=()=>{state.step++;render();};break;
    case 2:
      document.getElementById('passportNextBtn').onclick=()=>{
        state.passport=document.getElementById('passportInput').value;
        state.traveler.passport=state.passport;state.step++;render();
      };
      if(document.getElementById('qrbtn')){
        document.getElementById('qrbtn').onclick=function(){
          showQrModal(code=>{
            state.passport = code;
            state.qrData = code;
            render();
            setTimeout(()=>{document.getElementById('passportInput').value=state.passport;},100);
          });
        }
      }
      break;
    case 3: document.getElementById('travelerNextBtn').onclick=()=>{
      state.traveler.name=document.getElementById('travelerName').value;
      state.traveler.address=document.getElementById('travelerAddress').value;
      state.traveler.email=document.getElementById('travelerEmail').value;
      state.traveler.passport=document.getElementById('travelerPassport').value;
      state.step++;render();};break;
    case 4: 
      document.getElementById('datePickerBtn').onclick=function(){
        showDatePicker(state.residence.departure,date=>{state.residence.departure=date;render();});
      };
      document.getElementById('residenceNextBtn').onclick=()=>{
        state.residence.country=document.getElementById('residenceCountry').value;
        state.step++;render();
      };break;
    case 5:
      document.getElementById('membershipJoinBtn').onclick=()=>{state.memberEmail=document.getElementById('memberEmail').value;state.step++;render();};
      document.getElementById('membershipSkipBtn').onclick=()=>{state.memberEmail="";state.step++;render();};break;
    case 6:
      document.getElementById('scanReceiptBtn').onclick=()=>{state.receipts.push({number:''+(10000+Math.floor(Math.random()*90000)),amount:Math.floor(Math.random()*100+65),store:'NEWSTORE'});render();};
      document.getElementById('receiptsNextBtn').onclick=()=>{state.step++;render();};break;
    case 7:
      document.getElementById('refundCCBtn').onclick=()=>{state.refund='Credit Card';state.step++;render();};
      document.getElementById('refundWalletBtn').onclick=()=>{state.refund='Digital Wallet';state.step++;render();};
      document.getElementById('refundCashBtn').onclick=()=>{state.refund='Cash';state.step++;render();};break;
    case 8: document.getElementById('refundNextBtn').onclick=()=>{state.step++;render();};break;
    case 9:
      document.getElementById('agreeCheck').onchange=e=>{state.agreed = e.target.checked;}
      document.getElementById('showTermsLink').onclick=e=>{e.preventDefault();showPopup("Terms & Conditions","Standard T&C.<br/>For demo purposes.");};
      document.getElementById('showDeclarationLink').onclick=e=>{e.preventDefault();showPopup("Traveler Declaration","I confirm I'm not an EU resident, am above 16, and purchases will leave the EU.");};
      document.getElementById('submitBtn').onclick=()=>{if(!state.agreed)return alert("Please accept the Terms & Conditions and Traveler Declaration.");state.step=11;render();};break;
    case 10:
      document.getElementById('approveBtn').onclick=()=>{state.assistantApproved=true;state.step=11;render();};
      document.getElementById('rejectBtn').onclick=()=>{state.assistantApproved=false;state.step=0;render();};break;
    case 11:document.getElementById('finishBtn').onclick=()=>{state.step=12;render();};break;
  }
}
render();
  </script>
</body>
</html>
